
R version 2.13.0 (2011-04-13)
Copyright (C) 2011 The R Foundation for Statistical Computing
ISBN 3-900051-07-0
Platform: x86_64-unknown-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> library(coxme)
Loading required package: survival
Loading required package: splines
Loading required package: bdsmatrix
Loading required package: nlme
> options(na.action='na.exclude', contrasts=c('contr.treatment', 'contr.poly'))
> aeq <- function(x,y) all.equal(as.vector(x), as.vector(y))
> 
> #
> # Test of fitting random slopes
> #
> # Simulation data with 9 institutions, strong age effects
> #  and a random treatment effect
> #      
> set.seed(56)
> n.subject <- seq(180, by=21, length=9) # number of subjects
> slope <- sort(-.5 + rnorm(9, sd=.5))         # true treament effects
> 
> inst <- rep(1:9, n.subject)
> n <- length(inst)
> simdata <- data.frame(id=1:n, inst=inst,
+                       trt= rep(0:1, length=n),
+                       age= runif(n, 40, 70))
> #risk goes up 30%/decade of age
> simdata$hazard <- .8* exp(simdata$trt * rep(slope, n.subject) +
+                           (simdata$age-55) * .03)
> 
> rtime <- function(hazard, censor=c(1,2)) {
+     stime <- rexp(length(hazard), rate=hazard)
+     ctime <- runif(length(hazard), censor[1], censor[2])
+     list(time= pmin(stime, ctime), status=1*(stime <=ctime))
+     }
> temp <- rtime(simdata$hazard)
> simdata$time <- temp$time
> simdata$status <- temp$status
> 
> coef0 <- matrix(0., 2,9)
> for (i in 1:9) {
+     fit0 <- coxph(Surv(time, status) ~ age + trt, simdata,
+                   subset=(inst==i))
+     coef0[,i] <- fit0$coef
+     }
> 
> fit0 <- coxph(Surv(time, status) ~ age + trt, simdata)
> fit1 <- coxme(Surv(time, status) ~ age + trt + (1|inst), simdata)
> print(fit1, rcoef=TRUE)
Cox mixed-effects model fit by maximum likelihood
  Data: simdata
  events, n = 1504, 2376
  Iterations= 8 35 
                    NULL Integrated    Fitted
Log-likelihood -10892.32  -10826.57 -10819.37

                  Chisq   df p    AIC    BIC
Integrated loglik 131.5 3.00 0 125.50 109.55
 Penalized loglik 145.9 7.38 0 131.13  91.88

Model:  Surv(time, status) ~ age + trt + (1 | inst) 
Fixed and penalized coefficients
               coef exp(coef)    se(coef)     z       p
age     0.029947658 1.0304006 0.003022882  9.91 0.0e+00
trt    -0.249768573 0.7789810 0.051899221 -4.81 1.5e-06
inst.1 -0.122696316 0.8845322 0.078439022              
inst.2 -0.007690813 0.9923387 0.075520710              
inst.3 -0.043795090 0.9571501 0.074255042              
inst.4 -0.120717039 0.8862847 0.073123949              
inst.5  0.032153905 1.0326764 0.070790502              
inst.6  0.091249131 1.0955419 0.069919316              
inst.7 -0.017063124 0.9830816 0.068939947              
inst.8  0.024342099 1.0246408 0.067912721              
inst.9  0.164217246 1.1784703 0.066641443              

Random effects
 Group Variable  Std Dev    Variance  
 inst  Intercept 0.11329001 0.01283463
> fit2 <- coxme(Surv(time, status) ~ age + trt + (1|inst/trt), simdata)
> print(fit2, rcoef=TRUE)
Cox mixed-effects model fit by maximum likelihood
  Data: simdata
  events, n = 1504, 2376
  Iterations= 14 59 
                    NULL Integrated Fitted
Log-likelihood -10892.32  -10814.83 -10796

                   Chisq   df p    AIC    BIC
Integrated loglik 154.98  4.0 0 146.98 125.72
 Penalized loglik 192.65 14.2 0 164.25  88.78

Model:  Surv(time, status) ~ age + trt + (1 | inst/trt) 
Fixed and penalized coefficients
                      coef exp(coef)   se(coef)     z      p
age           0.0309018644 1.0313843 0.00303553 10.18 0.0000
trt          -0.3034676602 0.7382538 0.10866555 -2.79 0.0052
inst/trt.1/0 -0.0379408122 0.9627699 0.12209281             
inst/trt.1/1 -0.2624384353 0.7691737 0.13045067             
inst/trt.2/0  0.0939709843 1.0985279 0.11654037             
inst/trt.2/1 -0.1248346405 0.8826428 0.12497583             
inst/trt.3/0  0.1112525972 1.1176772 0.11498371             
inst/trt.3/1 -0.2200752228 0.8024584 0.12246057             
inst/trt.4/0 -0.1238429984 0.8835185 0.11411364             
inst/trt.4/1 -0.1550380090 0.8563826 0.12008275             
inst/trt.5/0  0.0436242263 1.0445898 0.11023645             
inst/trt.5/1  0.0274084707 1.0277875 0.11526576             
inst/trt.6/0  0.1545757903 1.1671627 0.10811359             
inst/trt.6/1  0.0420687445 1.0429662 0.11445798             
inst/trt.7/0 -0.0355616426 0.9650632 0.10859276             
inst/trt.7/1 -0.0008642463 0.9991361 0.11119348             
inst/trt.8/0 -0.1498386679 0.8608468 0.10779740             
inst/trt.8/1  0.2275530755 1.2555241 0.10863732             
inst/trt.9/0 -0.0562394769 0.9453127 0.10532885             
inst/trt.9/1  0.4662202633 1.5939581 0.10656407             
inst.1       -0.0013898487 0.9986111 0.01364380             
inst.2       -0.0001428055 0.9998572 0.01364167             
inst.3       -0.0005035201 0.9994966 0.01364090             
inst.4       -0.0012903768 0.9987105 0.01364031             
inst.5        0.0003286669 1.0003287 0.01363875             
inst.6        0.0009098703 1.0009103 0.01363824             
inst.7       -0.0001685419 0.9998315 0.01363775             
inst.8        0.0003595830 1.0003596 0.01363717             
inst.9        0.0018969728 1.0018988 0.01363641             

Random effects
 Group    Variable    Std Dev      Variance    
 inst/trt (Intercept) 0.2011420192 0.0404581119
 inst     (Intercept) 0.0136820637 0.0001871989
> 
> fit3 <- coxme(Surv(time, status) ~ age + trt + (1|inst) + (trt|inst),simdata)
> print(fit3, rcoef=TRUE)
Cox mixed-effects model fit by maximum likelihood
  Data: simdata
  events, n = 1504, 2376
  Iterations= 24 100 
                    NULL Integrated    Fitted
Log-likelihood -10892.32  -10812.96 -10798.57

                   Chisq   df p    AIC    BIC
Integrated loglik 158.72  4.0 0 150.72 129.46
 Penalized loglik 187.51 10.8 0 165.91 108.49

Model:  Surv(time, status) ~ age + trt + (1 | inst) + (trt | inst) 
Fixed and penalized coefficients
                   coef exp(coef)    se(coef)     z      p
age         0.030725948 1.0312029 0.003030398 10.14 0.0000
trt        -0.305717730 0.7365945 0.106983498 -2.86 0.0043
inst.1     -0.021490961 0.9787383 0.056275926             
inst.2      0.022416773 1.0226699 0.055717441             
inst.3      0.024059449 1.0243512 0.055497440             
inst.4     -0.043647512 0.9572913 0.054511908             
inst.5      0.017339064 1.0174903 0.054219268             
inst.6      0.056074451 1.0576764 0.054110082             
inst.7     -0.010401296 0.9896526 0.053558046             
inst.8     -0.043025930 0.9578866 0.052915950             
inst.9     -0.001324039 0.9986768 0.052569384             
inst.1:trt -0.295988778 0.7437958 0.160865342             
inst.2:trt -0.158379388 0.8535259 0.153380135             
inst.3:trt -0.269592248 0.7636908 0.151071363             
inst.4:trt -0.136855619 0.8720961 0.148296924             
inst.5:trt  0.023454291 1.0237315 0.142431879             
inst.6:trt  0.006906506 1.0069304 0.141456868             
inst.7:trt  0.015485348 1.0156059 0.138499859             
inst.8:trt  0.296307087 1.3448831 0.135535655             
inst.9:trt  0.518662801 1.6797799 0.133108817             

Random effects
 Group Variable  Std Dev     Variance   
 inst  Intercept 0.062784773 0.003941928
 inst  trt       0.278570808 0.077601695
> 
> fit4 <- coxme(Surv(time, status) ~ age + trt + (1 +trt |inst), simdata)
> 
> sfit0 <- coxph(Surv(time, status) ~ age + trt + strata(inst), simdata)
> sfit1 <- coxme(Surv(time, status) ~ age + trt + (trt|inst) + strata(inst),
+                simdata)
> print(sfit1, rcoef=TRUE)
Cox mixed-effects model fit by maximum likelihood
  Data: simdata
  events, n = 1504, 2376
  Iterations= 9 39 
                    NULL Integrated    Fitted
Log-likelihood -7636.963  -7564.201 -7553.574

                   Chisq  df p    AIC    BIC
Integrated loglik 145.53 3.0 0 139.53 123.58
 Penalized loglik 166.78 8.3 0 150.18 106.06

Model:  Surv(time, status) ~ age + trt + (trt | inst) + strata(inst) 
Fixed and penalized coefficients
                  coef exp(coef)    se(coef)     z      p
age         0.03096561 1.0314500 0.003047176 10.16 0.0000
trt        -0.31038291 0.7331662 0.116557344 -2.66 0.0077
inst.1:trt -0.23573004 0.7899939 0.190679701             
inst.2:trt -0.23582545 0.7899185 0.179146144             
inst.3:trt -0.34249094 0.7099996 0.176380428             
inst.4:trt -0.03709138 0.9635881 0.174722385             
inst.5:trt -0.01857601 0.9815955 0.165977320             
inst.6:trt -0.09181510 0.9122738 0.163465151             
inst.7:trt  0.03375505 1.0343312 0.162327165             
inst.8:trt  0.39189248 1.4797786 0.159311990             
inst.9:trt  0.53588140 1.7089539 0.155061855             

Random effects
 Group Variable Std Dev    Variance  
 inst  trt      0.31039655 0.09634602
> 
> #Comparison plot
> y <- cbind(slope, NA, coef0[2,], fixef(sfit1)[2] + unlist(sfit1$frail),
+            fixef(fit3)[2] + fit3$frail[[2]],
+            fixef(fit4)[2] + fit4$frail[[1]][,2])
> matplot(c(1, 1.5, 2:5), t(y), type='b', xaxt='n', xlab="Simulation", 
+         ylab="Treatment coefficient", lty=1)
> axis(1, 1:5, c("Sim", "Separate", "Strata", "Uncor", "Corr"))
> 
> 
> #
> # Now compute some things exactly
> #
> contr.none <- function(n,contrasts=T) {
+         if(is.numeric(n) && length(n) == 1.)
+                 levs <- 1.:n
+         else {
+                 levs <- n
+                 n <- length(n)
+         }
+         contr <- array(0., c(n, n), list(levs, levs))
+         contr[seq(1., n^2., n + 1.)] <- 1.
+         contr
+         }
> options(contrasts=c('contr.none', 'contr.poly'))
> igchol <- function(x) {
+     dd <- diag(x)
+     ll <- as.matrix(x)
+     ll %*% diag(dd) %*% t(ll)
+     }
> 
> # For fit2
> vtemp <- unlist(ranef(fit2))
> names(vtemp) <- names(ranef(fit2))
> fit2a <- coxme(Surv(time, status) ~ age + trt + (1|inst/trt), simdata,
+                iter=0, vfixed=vtemp)
> temp <- strata(simdata$inst, simdata$trt, sep='/', shortlabel=TRUE)
> cfit <- coxph(Surv(time, status) ~ factor(temp) +factor(inst) +age + trt,
+               simdata, iter=0, x=T)
> dt2 <- coxph.detail(cfit)
> u2 <- apply(dt2$score, 2, sum)
> aeq(u2, fit2a$u)
[1] TRUE
> imat2 <- apply(dt2$imat, 1:2, sum) + diag(c(rep(1/vtemp, c(18,9)),0,0))
> aeq(imat2, as.matrix(igchol(fit2a$hmat)))
[1] TRUE
> 
> # For fit3
> vtemp <- as.vector(unlist(ranef(fit3)))  #name not needed
> fit3a <- coxme(Surv(time, status) ~ age + trt + (1|inst) + (trt|inst),
+                simdata, iter=0, vfixed=as.list(vtemp))
> cfit <- coxph(Surv(time, status) ~ factor(inst) * trt + age, simdata,
+               iter=0, x=T)
> dt3 <- coxph.detail(cfit)
> u3 <- apply(dt3$score, 2, sum)
> indx <- c(1:9, 12:20, 11, 10)
> aeq(u3[indx], fit3a$u)
[1] TRUE
> imat2 <- apply(dt3$imat, 1:2, sum)[indx,indx] + 
+     diag(c(rep(1/vtemp, c(9,9)),0,0))
> aeq(imat2, as.matrix(igchol(fit3a$hmat)))
[1] TRUE
> 
> fit3b <- coxme(Surv(time, status) ~ age + trt + (trt|inst) +(1|inst),
+                simdata, iter=0, vfixed=as.list(rev(vtemp)))
> aeq(fit3a$u, fit3b$u)
[1] TRUE
> aeq(fit3b$imat, fit3b$imat)
[1] TRUE
> 
> #For sfit1
> vtemp <- .0966
> fit <- coxme(Surv(time, status) ~ age + trt + strata(inst) + (trt|inst),
+                simdata, iter=0, vfixed=vtemp)
> cfit <- coxph(Surv(time, status) ~ factor(inst):trt + trt+ age+ strata(inst),
+               simdata, iter=0, x=T)
> dt3 <- coxph.detail(cfit)
> u3 <- apply(dt3$score, 2, sum)
> indx <- c(3:11,2,1)
> aeq(u3[indx], fit$u)
[1] TRUE
> 
> imat3 <- apply(dt3$imat,1:2, sum)[indx,indx] + diag(c(rep(1/vtemp,9),0,0))
> aeq(imat3, as.matrix(igchol(fit$hmat)))
[1] TRUE
> 
> 
